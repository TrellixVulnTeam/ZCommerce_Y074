{"ast":null,"code":"import connectDB from '../../../utils/connectDB';\nimport Order from '../../../models/orderModel';\nimport Product from '../../../models/productModel';\nimport auth from '../../../middleware/auth';\nconnectDB();\nexport default (async (req, res) => {\n  switch (req.method) {\n    case \"PATCH\":\n      await paymentOrder(req, res);\n      break;\n  }\n});\n\nconst paymentOrder = async (req, res) => {\n  try {\n    const result = await auth(req, res);\n    const {\n      id\n    } = req.query;\n    await Order.findOneAndUpdate({\n      _id: id\n    }, {\n      paid: true,\n      dateOfPayment: new Date().toISOString()\n    });\n    res.json({\n      msg: `Payment success`\n    });\n  } catch (error) {\n    return res.status(500).json({\n      err: err.message\n    });\n  }\n};\n\nconst getOrders = async (req, res) => {\n  try {\n    const result = await auth(req, res);\n    let orders;\n\n    if (result.role !== \"admin\") {\n      orders = await Order.find({\n        user: result.id\n      }).populate(\"user\", \"-password\");\n    } else {\n      orders = await Order.find().populate(\"user\", \"-password\");\n    }\n\n    res.json({\n      orders\n    });\n  } catch (err) {\n    return res.status(500).json({\n      err: err.message\n    });\n  }\n};\n\nconst createOrder = async (req, res) => {\n  try {\n    const result = await auth(req, res);\n    const {\n      address,\n      mobile,\n      cart,\n      total\n    } = req.body;\n    const newOrder = new Order({\n      user: result.id,\n      address,\n      mobile,\n      cart,\n      total\n    });\n    cart.filter(item => {\n      return sold(item._id, item.quantity, item.inStock, item.sold);\n    });\n    newOrder.save();\n    return res.json({\n      msg: 'Payment Success',\n      newOrder\n    });\n  } catch (err) {\n    return res.status(500).json({\n      err: err.message\n    });\n  }\n};\n\nconst sold = async (id, quantity, oldInStock, oldStock) => {\n  await Product.findOneAndUpdate({\n    _id: id\n  }, {\n    inStock: oldInStock - quantity,\n    sold: quantity + oldStock\n  });\n};","map":{"version":3,"sources":["/home/zuares/Documents/Project/ZCommerce/pages/api/order/index.js"],"names":["connectDB","Order","Product","auth","req","res","method","paymentOrder","result","id","query","findOneAndUpdate","_id","paid","dateOfPayment","Date","toISOString","json","msg","error","status","err","message","getOrders","orders","role","find","user","populate","createOrder","address","mobile","cart","total","body","newOrder","filter","item","sold","quantity","inStock","save","oldInStock","oldStock"],"mappings":"AAAA,OAAOA,SAAP,MAAsB,0BAAtB;AACA,OAAOC,KAAP,MAAkB,4BAAlB;AACA,OAAOC,OAAP,MAAoB,8BAApB;AACA,OAAOC,IAAP,MAAiB,0BAAjB;AAEAH,SAAS;AAET,gBAAe,OAAOI,GAAP,EAAYC,GAAZ,KAAoB;AAC/B,UAAQD,GAAG,CAACE,MAAZ;AACI,SAAK,OAAL;AACI,YAAMC,YAAY,CAACH,GAAD,EAAMC,GAAN,CAAlB;AACA;AAHR;AAKH,CAND;;AAQA,MAAME,YAAY,GAAG,OAAOH,GAAP,EAAYC,GAAZ,KAAoB;AACrC,MAAI;AACA,UAAMG,MAAM,GAAG,MAAML,IAAI,CAACC,GAAD,EAAMC,GAAN,CAAzB;AACA,UAAM;AAAEI,MAAAA;AAAF,QAASL,GAAG,CAACM,KAAnB;AAEA,UAAMT,KAAK,CAACU,gBAAN,CAAuB;AAAEC,MAAAA,GAAG,EAAEH;AAAP,KAAvB,EAAoC;AACtCI,MAAAA,IAAI,EAAE,IADgC;AAC1BC,MAAAA,aAAa,EAAE,IAAIC,IAAJ,GAAWC,WAAX;AADW,KAApC,CAAN;AAGAX,IAAAA,GAAG,CAACY,IAAJ,CAAS;AAAEC,MAAAA,GAAG,EAAG;AAAR,KAAT;AAEH,GATD,CASE,OAAOC,KAAP,EAAc;AACZ,WAAOd,GAAG,CAACe,MAAJ,CAAW,GAAX,EAAgBH,IAAhB,CAAqB;AAAEI,MAAAA,GAAG,EAAEA,GAAG,CAACC;AAAX,KAArB,CAAP;AACH;AACJ,CAbD;;AAcA,MAAMC,SAAS,GAAG,OAAOnB,GAAP,EAAYC,GAAZ,KAAoB;AAClC,MAAI;AACA,UAAMG,MAAM,GAAG,MAAML,IAAI,CAACC,GAAD,EAAMC,GAAN,CAAzB;AAEA,QAAImB,MAAJ;;AACA,QAAIhB,MAAM,CAACiB,IAAP,KAAgB,OAApB,EAA6B;AACzBD,MAAAA,MAAM,GAAG,MAAMvB,KAAK,CAACyB,IAAN,CAAW;AAAEC,QAAAA,IAAI,EAAEnB,MAAM,CAACC;AAAf,OAAX,EAAgCmB,QAAhC,CAAyC,MAAzC,EAAiD,WAAjD,CAAf;AACH,KAFD,MAEO;AACHJ,MAAAA,MAAM,GAAG,MAAMvB,KAAK,CAACyB,IAAN,GAAaE,QAAb,CAAsB,MAAtB,EAA8B,WAA9B,CAAf;AACH;;AACDvB,IAAAA,GAAG,CAACY,IAAJ,CAAS;AAAEO,MAAAA;AAAF,KAAT;AACH,GAVD,CAUE,OAAOH,GAAP,EAAY;AACV,WAAOhB,GAAG,CAACe,MAAJ,CAAW,GAAX,EAAgBH,IAAhB,CAAqB;AAAEI,MAAAA,GAAG,EAAEA,GAAG,CAACC;AAAX,KAArB,CAAP;AACH;AACJ,CAdD;;AAgBA,MAAMO,WAAW,GAAG,OAAOzB,GAAP,EAAYC,GAAZ,KAAoB;AACpC,MAAI;AACA,UAAMG,MAAM,GAAG,MAAML,IAAI,CAACC,GAAD,EAAMC,GAAN,CAAzB;AACA,UAAM;AAAEyB,MAAAA,OAAF;AAAWC,MAAAA,MAAX;AAAmBC,MAAAA,IAAnB;AAAyBC,MAAAA;AAAzB,QAAmC7B,GAAG,CAAC8B,IAA7C;AACA,UAAMC,QAAQ,GAAG,IAAIlC,KAAJ,CAAU;AACvB0B,MAAAA,IAAI,EAAEnB,MAAM,CAACC,EADU;AACNqB,MAAAA,OADM;AACGC,MAAAA,MADH;AACWC,MAAAA,IADX;AACiBC,MAAAA;AADjB,KAAV,CAAjB;AAGAD,IAAAA,IAAI,CAACI,MAAL,CAAYC,IAAI,IAAI;AAChB,aAAOC,IAAI,CAACD,IAAI,CAACzB,GAAN,EAAWyB,IAAI,CAACE,QAAhB,EAA0BF,IAAI,CAACG,OAA/B,EAAwCH,IAAI,CAACC,IAA7C,CAAX;AACH,KAFD;AAIAH,IAAAA,QAAQ,CAACM,IAAT;AACA,WAAOpC,GAAG,CAACY,IAAJ,CAAS;AACZC,MAAAA,GAAG,EAAE,iBADO;AAEZiB,MAAAA;AAFY,KAAT,CAAP;AAIH,GAfD,CAeE,OAAOd,GAAP,EAAY;AACV,WAAOhB,GAAG,CAACe,MAAJ,CAAW,GAAX,EAAgBH,IAAhB,CAAqB;AAAEI,MAAAA,GAAG,EAAEA,GAAG,CAACC;AAAX,KAArB,CAAP;AACH;AACJ,CAnBD;;AAqBA,MAAMgB,IAAI,GAAG,OAAO7B,EAAP,EAAW8B,QAAX,EAAqBG,UAArB,EAAiCC,QAAjC,KAA8C;AACvD,QAAMzC,OAAO,CAACS,gBAAR,CAAyB;AAAEC,IAAAA,GAAG,EAAEH;AAAP,GAAzB,EAAsC;AACxC+B,IAAAA,OAAO,EAAEE,UAAU,GAAGH,QADkB;AAExCD,IAAAA,IAAI,EAAEC,QAAQ,GAAGI;AAFuB,GAAtC,CAAN;AAIH,CALD","sourcesContent":["import connectDB from '../../../utils/connectDB'\nimport Order from '../../../models/orderModel'\nimport Product from '../../../models/productModel'\nimport auth from '../../../middleware/auth'\n\nconnectDB()\n\nexport default async (req, res) => {\n    switch (req.method) {\n        case \"PATCH\":\n            await paymentOrder(req, res)\n            break;\n    }\n}\n\nconst paymentOrder = async (req, res) => {\n    try {\n        const result = await auth(req, res)\n        const { id } = req.query\n\n        await Order.findOneAndUpdate({ _id: id }, {\n            paid: true, dateOfPayment: new Date().toISOString()\n        })\n        res.json({ msg: `Payment success` })\n\n    } catch (error) {\n        return res.status(500).json({ err: err.message })\n    }\n}\nconst getOrders = async (req, res) => {\n    try {\n        const result = await auth(req, res)\n\n        let orders;\n        if (result.role !== \"admin\") {\n            orders = await Order.find({ user: result.id }).populate(\"user\", \"-password\")\n        } else {\n            orders = await Order.find().populate(\"user\", \"-password\")\n        }\n        res.json({ orders })\n    } catch (err) {\n        return res.status(500).json({ err: err.message })\n    }\n}\n\nconst createOrder = async (req, res) => {\n    try {\n        const result = await auth(req, res)\n        const { address, mobile, cart, total } = req.body\n        const newOrder = new Order({\n            user: result.id, address, mobile, cart, total\n        })\n        cart.filter(item => {\n            return sold(item._id, item.quantity, item.inStock, item.sold)\n        })\n\n        newOrder.save()\n        return res.json({\n            msg: 'Payment Success',\n            newOrder\n        })\n    } catch (err) {\n        return res.status(500).json({ err: err.message })\n    }\n}\n\nconst sold = async (id, quantity, oldInStock, oldStock) => {\n    await Product.findOneAndUpdate({ _id: id }, {\n        inStock: oldInStock - quantity,\n        sold: quantity + oldStock\n    })\n}"]},"metadata":{},"sourceType":"module"}